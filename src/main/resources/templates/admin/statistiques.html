<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiques - Administration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .sidebar {
            min-height: 100vh;
            background: #2c3e50;
            position: fixed;
            width: 250px;
        }

        .sidebar .nav-link {
            color: #ecf0f1;
            padding: 10px 15px;
        }

        .sidebar .nav-link:hover {
            background: #34495e;
        }

        .sidebar .nav-link.active {
            background: #3498db;
        }

        .main-content {
            margin-left: 250px;
            padding: 0;
        }

        .navbar {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px 30px;
        }

        .stat-card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .card-cartes-attente { border-left: 4px solid #f39c12; }
        .card-cartes-validees { border-left: 4px solid #27ae60; }
        .card-cartes-restituees { border-left: 4px solid #3498db; }
        .card-nouveaux-signalements { border-left: 4px solid #e74c3c; }

        .btn-primary {
            background: #3498db;
            border: none;
        }

        .btn-primary:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
<!-- Sidebar -->
<div class="sidebar d-none d-md-block">
    <div class="text-center py-4">
        <h4 class="text-white mb-0">
            <i class="bi bi-shield-lock"></i> Administration
        </h4>
        <small class="text-white-50">Cartes Perdues Sénégal</small>
    </div>

    <nav class="nav flex-column mt-3">
        <a class="nav-link" th:href="@{/admin/dashboard}">
            <i class="bi bi-speedometer2 me-2"></i> Dashboard
        </a>

        <a class="nav-link" th:href="@{/admin/cartes}">
            <i class="bi bi-credit-card me-2"></i> Cartes
        </a>

        <a class="nav-link" th:href="@{/admin/signalements}">
            <i class="bi bi-flag me-2"></i> Signalements
        </a>

        <a class="nav-link" th:href="@{/admin/administrateurs}">
            <i class="bi bi-people me-2"></i> Administrateurs
        </a>

        <a class="nav-link active" th:href="@{/admin/statistiques}">
            <i class="bi bi-bar-chart me-2"></i> Statistiques
        </a>

        <hr class="text-white-50 mx-3 my-2">

        <a class="nav-link" th:href="@{/admin/profil}">
            <i class="bi bi-person-circle me-2"></i> Mon Profil
        </a>

        <form th:action="@{/logout}" method="post" class="px-3 mt-2">
            <button type="submit" class="btn btn-outline-light w-100">
                <i class="bi bi-box-arrow-right me-2"></i> Déconnexion
            </button>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        </form>
    </nav>
</div>

<!-- Main Content -->
<div class="main-content">
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container-fluid">
            <h4 class="mb-0">
                <i class="bi bi-bar-chart text-primary me-2"></i> Statistiques
            </h4>

            <div class="d-flex align-items-center">
                    <span class="text-muted me-3">
                        <i class="bi bi-person-circle"></i>
                        <span th:text="${adminName}">Admin</span>
                    </span>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle"
                            data-bs-toggle="dropdown">
                        <i class="bi bi-download me-1"></i> Exporter
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="bi bi-file-pdf me-2"></i> PDF</a></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-file-excel me-2"></i> Excel</a></li>
                        <li><a class="dropdown-item" href="#" onclick="window.print()">
                            <i class="bi bi-printer me-2"></i> Imprimer
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Content -->
    <div class="container-fluid mt-4">
        <!-- Stats Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card card-cartes-attente">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Cartes en attente</h6>
                                <h3 th:text="${stats.cartesEnAttente}" class="mb-0">0</h3>
                            </div>
                            <div class="stat-icon text-warning">
                                <i class="bi bi-clock-history"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card stat-card card-cartes-validees">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Cartes validées</h6>
                                <h3 th:text="${stats.cartesValidees}" class="mb-0">0</h3>
                            </div>
                            <div class="stat-icon text-success">
                                <i class="bi bi-check-circle"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card stat-card card-cartes-restituees">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Cartes restituées</h6>
                                <h3 th:text="${stats.cartesRestituees}" class="mb-0">0</h3>
                            </div>
                            <div class="stat-icon text-primary">
                                <i class="bi bi-gift"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card stat-card card-nouveaux-signalements">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Nouveaux signalements</h6>
                                <h3 th:text="${stats.nouveauxSignalements}" class="mb-0">0</h3>
                            </div>
                            <div class="stat-icon text-danger">
                                <i class="bi bi-flag"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Detailed Stats -->
        <div class="row">
            <!-- Cartes par type -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-pie-chart text-primary me-2"></i> Cartes par type
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="cartesTypeChart"></canvas>
                        </div>
                        <div th:if="${cartesParType != null and !cartesParType.isEmpty()}"
                             class="mt-3 small">
                            <table class="table table-sm">
                                <tbody>
                                <tr th:each="stat : ${cartesParType}">
                                    <td th:text="${stat.type}">Type</td>
                                    <td>
                                        <span th:text="${stat.count}" class="badge bg-primary">0</span>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar" role="progressbar"
                                                 th:style="'width: ' + ${stat.percentage} + '%;'">
                                            </div>
                                        </div>
                                    </td>
                                    <td th:text="${stat.percentage} + '%'" class="text-end">0%</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Signalements par raison -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-bar-chart text-warning me-2"></i> Signalements par raison
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="signalementsRaisonChart"></canvas>
                        </div>
                        <div th:if="${signalementsParRaison != null and !signalementsParRaison.isEmpty()}"
                             class="mt-3 small">
                            <table class="table table-sm">
                                <tbody>
                                <tr th:each="stat : ${signalementsParRaison}">
                                    <td th:text="${stat.raison}">Raison</td>
                                    <td>
                                        <span th:text="${stat.count}" class="badge bg-warning">0</span>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-warning" role="progressbar"
                                                 th:style="'width: ' + ${stat.percentage} + '%;'">
                                            </div>
                                        </div>
                                    </td>
                                    <td th:text="${stat.percentage} + '%'" class="text-end">0%</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Statistics -->
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-people text-info me-2"></i> Administrateurs
                        </h6>
                    </div>
                    <div class="card-body text-center py-4">
                        <h1 th:text="${totalAdmins}" class="display-4 text-info mb-3">0</h1>
                        <p class="text-muted mb-0">Administrateurs actifs</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-calendar-check text-success me-2"></i> Activité récente
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h4 class="text-primary" th:text="${stats.cartesEnAttente}">0</h4>
                                <small class="text-muted">Cartes à traiter</small>
                            </div>
                            <div class="col-md-3">
                                <h4 class="text-warning" th:text="${stats.nouveauxSignalements}">0</h4>
                                <small class="text-muted">Signalements à examiner</small>
                            </div>
                            <div class="col-md-3">
                                <h4 class="text-success" th:text="${stats.cartesValidees}">0</h4>
                                <small class="text-muted">Cartes validées</small>
                            </div>
                            <div class="col-md-3">
                                <h4 class="text-info" th:text="${stats.cartesRestituees}">0</h4>
                                <small class="text-muted">Cartes restituées</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-file-text text-secondary me-2"></i> Résumé statistique
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Performances</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                Taux de validation: <strong th:text="'75%'">75%</strong>
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-clock text-warning me-2"></i>
                                Temps moyen de traitement: <strong>2.5 jours</strong>
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-arrow-repeat text-primary me-2"></i>
                                Taux de restitution: <strong th:text="'60%'">60%</strong>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Distribution</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="bi bi-pie-chart-fill text-info me-2"></i>
                                Cartes CNI: <strong th:text="'45%'">45%</strong>
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-pie-chart-fill text-success me-2"></i>
                                Permis de conduire: <strong th:text="'30%'">30%</strong>
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-pie-chart-fill text-warning me-2"></i>
                                Autres cartes: <strong th:text="'25%'">25%</strong>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Chart for Cartes par type
    document.addEventListener('DOMContentLoaded', function() {
        const ctx1 = document.getElementById('cartesTypeChart').getContext('2d');
        new Chart(ctx1, {
            type: 'pie',
            data: {
                labels: ['CNI', 'Permis', 'Carte scolaire', 'Badge', 'Autres'],
                datasets: [{
                    data: [45, 30, 15, 7, 3],
                    backgroundColor: [
                        '#3498db',
                        '#2ecc71',
                        '#f39c12',
                        '#9b59b6',
                        '#e74c3c'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Chart for Signalements par raison
        const ctx2 = document.getElementById('signalementsRaisonChart').getContext('2d');
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: ['Fraude', 'Info erronée', 'Publication abusive', 'Doublon', 'Autre'],
                datasets: [{
                    label: 'Nombre de signalements',
                    data: [12, 8, 5, 3, 2],
                    backgroundColor: '#f39c12',
                    borderColor: '#d68910',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 2
                        }
                    }
                }
            }
        });
    });
</script>
</body>
</html>